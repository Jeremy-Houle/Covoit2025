document.addEventListener("DOMContentLoaded",()=>{function x(t){let e=0;return t.forEach(n=>{e+=Number(n)||0}),e}function y(t){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"CAD"}).format(t)}const r=document.querySelector(".total-amount");if(r&&r.dataset&&r.dataset.paiements)try{const t=JSON.parse(r.dataset.paiements),e=x(t);r.textContent=y(e)}catch(t){console.error("Erreur lors du calcul du total:",t),r.textContent="Erreur de calcul"}else r&&(r.textContent=y(0));const m=document.getElementById("paymentAmount");if(m&&m.dataset&&m.dataset.paiements)try{const t=JSON.parse(m.dataset.paiements),e=x(t);m.textContent=`Montant : ${y(e)}`}catch(t){console.error("Erreur lors du calcul du montant:",t)}const v=document.querySelectorAll(".trajet-card");v.forEach(t=>{t.addEventListener("mouseenter",function(){this.style.transform="translateY(-5px)"}),t.addEventListener("mouseleave",function(){this.style.transform="translateY(0)"})}),document.querySelectorAll(".btn-pay").forEach(t=>{t.addEventListener("click",function(e){const n=this.innerHTML;this.innerHTML='<i class="fas fa-spinner fa-spin"></i> Traitement...',this.disabled=!0,setTimeout(()=>{this.innerHTML=n,this.disabled=!1},2e3)})});const b=document.querySelector(".btn-home");b&&(b.addEventListener("mouseenter",function(){this.style.transform="translateY(-3px) scale(1.05)"}),b.addEventListener("mouseleave",function(){this.style.transform="translateY(0) scale(1)"}));const B=document.getElementById("paymentModal");B&&B.addEventListener("show.bs.modal",function(){this.style.opacity="0",setTimeout(()=>{this.style.opacity="1"},100)});const k={threshold:.1,rootMargin:"0px 0px -50px 0px"},S=new IntersectionObserver(t=>{t.forEach(e=>{e.isIntersecting&&(e.target.style.opacity="1",e.target.style.transform="translateY(0)")})},k);v.forEach(t=>{t.style.opacity="0",t.style.transform="translateY(20px)",t.style.transition="opacity 0.6s ease, transform 0.6s ease",S.observe(t)});const p=document.querySelector(".summary-card");p&&(p.style.opacity="0",p.style.transform="translateX(20px)",p.style.transition="opacity 0.6s ease, transform 0.6s ease",S.observe(p)),document.querySelectorAll(".btn-pay").forEach(t=>{t.addEventListener("click",function(e){e.preventDefault();const n=this.dataset.conducteurId,o=this.dataset.utilisateurId,s=this.dataset.paiementId,a=this.dataset.montant,c=this.dataset.conducteurNom,i=this.dataset.depart,l=this.dataset.destination,d=this.dataset.date,f=this.dataset.heure,h=this.dataset.places;document.getElementById("modalConducteur").textContent=c,document.getElementById("modalDepart").textContent=i,document.getElementById("modalDestination").textContent=l,document.getElementById("modalDate").textContent=d,document.getElementById("modalHeure").textContent=f,document.getElementById("modalPlaces").textContent=h,document.getElementById("modalMontant").textContent=`${parseFloat(a).toFixed(2)} $`;const w=document.getElementById("confirmPaymentForm");w&&(w.action=`/payer-panier/${n}/${o}/${s}`);const C=document.getElementById("paymentConfirmationModal");C&&(new bootstrap.Modal(C,{backdrop:!0,keyboard:!0,focus:!0}).show(),setTimeout(()=>{C.setAttribute("aria-hidden","false")},100))})});const g=document.getElementById("confirmPaymentForm");g&&g.addEventListener("submit",function(t){const e=this.querySelector('button[type="submit"]');e&&(e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Traitement...',e.disabled=!0)});const E=document.getElementById("paymentConfirmationModal");E&&(E.addEventListener("hidden.bs.modal",function(){this.setAttribute("aria-hidden","true"),document.querySelectorAll(".modal-backdrop").forEach(n=>n.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="",document.querySelectorAll(".btn-pay").forEach(n=>{n.innerHTML='<i class="fas fa-credit-card"></i> Payer ce trajet',n.disabled=!1})}),E.addEventListener("hide.bs.modal",function(){const t=document.querySelector('#confirmPaymentForm button[type="submit"]');t&&(t.innerHTML='<i class="fas fa-credit-card"></i> Confirmer le paiement',t.disabled=!1)})),document.querySelectorAll(".badge-waiting").forEach(t=>{t.style.animation="pulse 2s infinite"});const I=document.createElement("style");I.textContent=`
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .trajet-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-pay {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-home {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    `,document.head.appendChild(I),document.querySelectorAll(".alert").forEach(t=>{setTimeout(()=>{t&&t.parentNode&&(t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout(()=>{t.remove()},300))},5e3)}),window.cleanupModalBackdrops=function(){document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},setInterval(()=>{document.querySelectorAll(".modal-backdrop").length>0&&!document.querySelector(".modal.show")&&window.cleanupModalBackdrops()},2e3);function T(){const t=document.querySelectorAll(".btn-places-minus"),e=document.querySelectorAll(".btn-places-plus");t.forEach(n=>{n.addEventListener("click",function(){const o=this.dataset.paiementId,s=document.querySelector(`.places-count[data-paiement-id="${o}"]`),a=parseInt(s.textContent);a>1&&q(o,a-1)})}),e.forEach(n=>{n.addEventListener("click",function(){const o=this.dataset.paiementId,s=document.querySelector(`.places-count[data-paiement-id="${o}"]`),a=parseInt(s.textContent);!this.disabled&&this.dataset.maxReached!=="true"&&(this.disabled=!0,this.style.opacity="0.5",q(o,a+1),setTimeout(()=>{this.disabled&&(this.disabled=!1,this.style.opacity="1")},1e3))})})}function L(){document.querySelectorAll(".places-count").forEach(e=>{const n=e.dataset.paiementId,o=parseInt(e.textContent),s=e.dataset.trajetId;s?fetch(`/trajets/${s}/availability`).then(a=>a.json()).then(a=>{if(a.places_disponibles!==void 0){const c=o+a.places_disponibles;u(n,o,c)}else u(n,o)}).catch(a=>{console.error("Erreur lors de la récupération des places disponibles:",a),u(n,o)}):u(n,o)})}function q(t,e){const n=document.querySelector(`.places-count[data-paiement-id="${t}"]`),o=n.textContent;n.textContent="...";const s=document.querySelector(`.btn-places-minus[data-paiement-id="${t}"]`),a=document.querySelector(`.btn-places-plus[data-paiement-id="${t}"]`);s.disabled=!0,a.disabled=!0,fetch("/update-places",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRF-TOKEN":window.csrfToken},body:new URLSearchParams({paiement_id:t,places:e,_token:window.csrfToken})}).then(c=>c.json()).then(c=>{if(c.success){n.textContent=c.places;const i=n.closest(".trajet-card"),l=i.querySelector(".price-breakdown .price-item:first-child .price-value");l&&(l.textContent=`${parseFloat(c.price_per_place).toFixed(2)} $`);const d=i.querySelector(".price-breakdown .price-item.total .price-value");d&&(d.textContent=`${parseFloat(c.new_amount).toFixed(2)} $`);const f=i.querySelector(".btn-pay");f&&(f.dataset.places=c.places,f.dataset.montant=c.new_amount);const h=document.querySelector(`.summary-price[data-paiement-id="${t}"]`);h&&(h.textContent=`${parseFloat(c.new_amount).toFixed(2)} $`),M(),u(t,c.places,c.places_disponibles+c.places)}else n.textContent=o,c.max_places&&u(t,parseInt(o),c.max_places-parseInt(o))}).catch(c=>{console.error("Erreur:",c),n.textContent=o,alert("Erreur lors de la mise à jour des places")}).finally(()=>{s.disabled=!1,a.disabled=!1,a.style.opacity="1",a.dataset.maxReached!=="true"&&(a.dataset.maxReached="false")})}function u(t,e,n=null){const o=document.querySelector(`.btn-places-minus[data-paiement-id="${t}"]`),s=document.querySelector(`.btn-places-plus[data-paiement-id="${t}"]`);o.disabled=e<=1,n&&(e>=n?(s.disabled=!0,s.dataset.maxReached="true",s.style.opacity="0.5",s.title=`Maximum atteint: ${n} places`):(s.disabled=!1,s.dataset.maxReached="false",s.style.opacity="1",s.title=`Places disponibles: ${n-e}`))}function M(){const t=document.querySelector(".total-amount");if(t){const e=document.querySelectorAll(".trajet-card");let n=0;e.forEach(o=>{const s=o.querySelector(".price-breakdown .price-item.total .price-value");if(s){const a=parseFloat(s.textContent.replace(/[^0-9.-]/g,""))||0;n+=a}}),t.textContent=y(n)}}function $(){console.log("Initialisation des boutons supprimer...");const t=document.querySelectorAll(".btn-remove");console.log("Nombre de boutons trouvés:",t.length);const e=document.getElementById("deleteConfirmationModal");if(!e){console.error("Modal deleteConfirmationModal introuvable !");return}const n=new bootstrap.Modal(e),o=document.getElementById("confirmDeleteBtn"),s=document.getElementById("deleteTrajetInfo");let a=null;t.forEach(c=>{c.addEventListener("click",function(){console.log("Bouton supprimer cliqué !");const i=this.dataset.paiementId,l=this.dataset.depart,d=this.dataset.destination;console.log("Paiement à supprimer:",i,l,d),a=i,s&&(s.textContent=`Trajet : ${l} → ${d}`),n.show()})}),o&&o.addEventListener("click",function(){console.log("Confirmation de suppression pour:",a),a&&(n.hide(),A(a),a=null)}),e.addEventListener("hidden.bs.modal",function(){a=null})}function A(t){const e=document.createElement("form");e.method="POST",e.action="/remove-from-cart";const n=document.createElement("input");n.type="hidden",n.name="_token",n.value=window.csrfToken,e.appendChild(n);const o=document.createElement("input");o.type="hidden",o.name="paiement_id",o.value=t,e.appendChild(o),document.body.appendChild(e),e.submit()}T(),L(),$()});
