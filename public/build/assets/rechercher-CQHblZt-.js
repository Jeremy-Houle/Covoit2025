window.FavoritesManager={_favoritesCache:null,_loading:!1,getFavorites:async function(){if(this._favoritesCache!==null&&!this._loading)return this._favoritesCache;if(this._loading)return new Promise(u=>{const o=setInterval(()=>{this._loading||(clearInterval(o),u(this._favoritesCache||[]))},100)});this._loading=!0;try{const u=await fetch("/api/favoris?type=Rechercher",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}});if(u.ok){const o=await u.json();return this._favoritesCache=Array.isArray(o)?o:[],this._loading=!1,this._favoritesCache}else return u.status===401?(this._favoritesCache=[],this._loading=!1,[]):(this._favoritesCache=[],this._loading=!1,[])}catch{return this._favoritesCache=[],this._loading=!1,[]}},isFavorite:async function(u){return(await this.getFavorites()).includes(String(u))},toggleFavorite:async function(u){if(this._toggling)return await new Promise(o=>setTimeout(o,100)),this.toggleFavorite(u);this._toggling=!0;try{const o=await fetch("/api/favoris/toggle",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.csrfToken||"","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({IdTrajet:Number(u),TypeFavori:"Rechercher"})});if(o.ok){const p=await o.json();return this._favoritesCache=null,await this.getFavorites(),p.isFavorite!==void 0?p.isFavorite:p.success===!0}else{if(o.status===401)return alert("Veuillez vous connecter pour ajouter des trajets aux favoris."),!1;{const p=await o.json().catch(()=>({}));return alert(p.message||"Erreur lors de l'ajout aux favoris"),!1}}}catch{return alert("Erreur réseau lors de l'ajout aux favoris"),!1}finally{this._toggling=!1}},invalidateCache:function(){this._favoritesCache=null}};window.openDetailsIds=window.openDetailsIds||new Set;document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("searchForm"),o=document.getElementById("results"),p=document.getElementById("myReservations"),v=document.getElementById("filterFavoris");if(!u||!o)return;const b=window.toggleDetails;b&&(window.toggleDetails=function(e){const r=b.apply(this,arguments),n=document.getElementById("details-"+e);return n&&(n.style.display==="block"?window.openDetailsIds.add(String(e)):window.openDetailsIds.delete(String(e))),r});async function x(){const e=document.querySelectorAll("#results .trajet");for(const r of e){const n=r.dataset.id,t=r.querySelector(".btn-favorite");if(t&&n){const i=await FavoritesManager.isFavorite(n);t.classList.toggle("active",i),t.innerHTML=i?'<i class="fa-solid fa-star"></i>':'<i class="fa-regular fa-star"></i>',t.style.color=i?"#ffc107":"#666",t.title=i?"Retirer des favoris":"Ajouter aux favoris"}}}async function j(e){const r=document.querySelectorAll("#results .trajet");let n=0;const t=o.querySelector(".no-favorites-message");if(t&&t.remove(),!e){r.forEach(s=>{s.style.display="",n++});return}const i=await FavoritesManager.getFavorites();if(r.forEach(s=>{const l=s.dataset.id;if(!l){s.style.display="none";return}i.includes(String(l))?(s.style.display="",n++):s.style.display="none"}),e&&n===0){const s=document.createElement("p");s.className="no-favorites-message",s.style.cssText="text-align:center;padding:20px;color:#666;font-style:italic;margin-top:20px;",s.textContent="Aucun trajet en favoris pour le moment. Cliquez sur l'étoile d'un trajet pour l'ajouter aux favoris.",o.appendChild(s)}}v&&v.addEventListener("change",async e=>{await j(e.target.checked)});async function $(e){if(e.disabled||e.hasAttribute("data-processing"))return;const r=e.closest(".trajet");if(!r)return;const n=r.dataset.id;if(!n)return;e.setAttribute("data-processing","true"),e.disabled=!0;const t=e.innerHTML;e.innerHTML='<i class="fa fa-spinner fa-spin"></i>';try{const i=await FavoritesManager.toggleFavorite(n);if(e.classList.toggle("active",i),e.innerHTML=i?'<i class="fa-solid fa-star"></i>':'<i class="fa-regular fa-star"></i>',e.style.color=i?"#ffc107":"#666",e.title=i?"Retirer des favoris":"Ajouter aux favoris",v&&v.checked&&!i&&(r.style.display="none",document.querySelectorAll('#results .trajet:not([style*="display: none"])').length===0)){const l=document.createElement("p");l.className="no-favorites-message",l.style.cssText="text-align:center;padding:20px;color:#666;font-style:italic;margin-top:20px;",l.textContent="Aucun trajet en favoris pour le moment. Cliquez sur l'étoile d'un trajet pour l'ajouter aux favoris.",o.querySelector(".no-favorites-message")||o.appendChild(l)}}catch{e.innerHTML=t}finally{e.disabled=!1,e.removeAttribute("data-processing")}}x();async function w(){if(p){p.innerHTML="<p>Chargement de vos réservations…</p>";try{let e=await fetch("/api/reservations",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}});if(e.status===404&&(e=await fetch("/reservations",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})),e.status===401||e.status===403){p.innerHTML="",console.warn("Accès refusé:",e.status);return}if((e.headers.get("content-type")||"").includes("application/json")){const n=await e.json();!Array.isArray(n)||n.length===0?p.innerHTML="<p>Aucune réservation pour le moment.</p>":p.innerHTML=n.map(t=>{const i=t.Trajet||t.trajet||{},s=i.NomConducteur||i.IdTrajet?`Trajet #${i.IdTrajet||""}`:"Réservation",l=i.Depart||t.Depart||"—",c=i.Destination||t.Destination||"—",d=t.PlacesReservees??t.places??1,f=i.DateTrajet||t.DateTrajet||"";return`
                            <div class="reservation card mb-2 p-2" data-id="${t.IdReservation||t.id||""}">
                                <div><strong>${s}</strong></div>
                                <div>Départ: ${l} — Destination: ${c}</div>
                                <div>Date: ${f} — Places: ${d}</div>
                            </div>
                        `}).join("")}else{const n=await e.text();p.innerHTML=n||"<p>Aucune réservation pour le moment.</p>"}}catch{p.innerHTML="<p>Impossible de charger vos réservations (erreur réseau).</p>"}}}w(),u.addEventListener("submit",async e=>{e.preventDefault();const r=Object.fromEntries(new FormData(u)),n=u.action&&u.action!==""?u.action:"/api/trajets/search",t=new Set;o.querySelectorAll(".trajet").forEach(s=>{const l=s.dataset.id;if(!l)return;const c=document.getElementById(`details-${l}`),d=s.querySelector(`.btn-details-${l}`);if(c&&d){const f=c.style.display,a=d.textContent.trim();(f==="block"||a==="Masquer")&&t.add(String(l))}}),o.innerHTML="<p>Recherche…</p>";try{const s=n+"?"+new URLSearchParams(r).toString(),l=await fetch(s,{headers:{"X-Requested-With":"XMLHttpRequest"}});if((l.headers.get("content-type")||"").includes("application/json")){const d=await l.json();if(!Array.isArray(d)||d.length===0)o.innerHTML="<p>Aucun trajet trouvé.</p>";else{const f=await FavoritesManager.getFavorites();o.innerHTML=d.map(a=>{const m=f.includes(String(a.IdTrajet)),g=Math.max(0,Number(a.PlacesDisponibles)||0),y=Math.max(1,g),I=Array.from({length:y},(S,A)=>{const h=A+1,R=h>g?"disabled":"";return`<option value="${h}" ${R}>${h}</option>`}).join(""),F=String(a.IdTrajet),C=t.has(F),k=C?"block":"none",E=C?"Masquer":"Détails",q=window.userRole==="Conducteur"?"":`
                            <div class="reserve-controls" style="display:flex;gap:6px;align-items:center;justify-content:center;margin-top:6px;">
                                <select class="places-select form-select form-select-sm" data-id="${a.IdTrajet}" style="width:48px;max-width:48px;padding:.12rem .25rem;font-size:.82rem;height:30px;" ${g===0?"disabled":""}>
                                    ${I}
                                </select>
                                <button type="button" class="btn-add btn btn-sm btn-primary" data-id="${a.IdTrajet}" ${g===0?"disabled":""}>Réserver ce trajet</button>
                            </div>
                        `,D=a.comment_count||0,H=D>0?`<span class="comment-badge" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${D}</span>`:"";return`
                        <div class="trajet card mb-2 p-2" data-id="${a.IdTrajet}" style="position: relative; padding-bottom: 50px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div><strong>${a.NomConducteur||"Conducteur"}</strong></div>
                                <div style="display:flex;gap:6px;">
                                    <button type="button" class="btn-favorite btn btn-sm ${m?"active":""}" data-id="${a.IdTrajet}" title="${m?"Retirer des favoris":"Ajouter aux favoris"}" style="color:${m?"#ffc107":"#666"};border:none;background:transparent;padding:4px 8px;cursor:pointer;">
                                        <i class="${m?"fa-solid fa-star":"fa-regular fa-star"}"></i>
                                    </button>
                                    <button type="button" class="btn-details btn-details-${a.IdTrajet} btn btn-sm btn-outline-secondary" data-id="${a.IdTrajet}" onclick="toggleDetails(${a.IdTrajet})">${E}</button>
                                </div>
                            </div>
                            <div>Départ: ${a.Depart} — Destination: ${a.Destination}</div>
                            <div>Date: ${a.DateTrajet} — Heure: ${a.HeureTrajet}</div>
                            <div>Places: <span class="places-dispo">${a.PlacesDisponibles}</span> — Prix: ${Number(a.Prix).toFixed(2)}$</div>
                            ${q}
                            <div class="trajet-details trajet-details-${a.IdTrajet}" id="details-${a.IdTrajet}" style="display:${k};margin-top:8px;border-top:1px dashed #eee;padding-top:8px;font-size:0.95rem;background:var(--gray-50);padding:12px;border-radius:8px;box-shadow:inset 2px 2px 5px rgba(0, 0, 0, 0.2),inset -2px -2px 5px rgba(255, 255, 255, 0.8);">
                                <div><strong style="color:var(--primary-blue);font-size:1.1rem;">Détails complets</strong></div>
                                <div style="margin-top:8px;"><i class="fa fa-user"></i> Conducteur : ${a.NomConducteur||"—"}</div>
                                <div><i class="fa fa-road"></i> Distance : ${a.Distance??"—"}</div>
                                <div><i class="fa fa-map-marker-alt"></i> Départ : ${a.Depart??"—"}</div>
                                <div><i class="fa fa-flag-checkered"></i> Destination : ${a.Destination??"—"}</div>
                                <div><i class="fa fa-calendar"></i> Date / Heure : ${a.DateTrajet??"—"} ${a.HeureTrajet??""}</div>
                                <div><i class="fa fa-chair"></i> Places disponibles : ${a.PlacesDisponibles??"—"}</div>
                                <div><i class="fa fa-dollar-sign"></i> Prix par place : ${Number(a.Prix??0).toFixed(2)}$</div>
                                <div><i class="fa fa-paw"></i> Animaux acceptés : ${a.AnimauxAcceptes?"Oui":"Non"}</div>
                                <div><i class="fa fa-comments"></i> Type conversation : ${a.TypeConversation??"—"}</div>
                                <div><i class="fa fa-music"></i> Musique : ${a.Musique?"Oui":"Non"}</div>
                                <div><i class="fa fa-smoking"></i> Fumeur : ${a.Fumeur?"Oui":"Non"}</div>
                            </div>
                            <div style="margin-top: 12px; position: relative; min-height: 40px;">
                                <div style="position: absolute; top: 0; left: 0; z-index: 10; cursor: pointer;" class="comment-icon-wrapper">
                                    <div style="position: relative; display: inline-block;">
                                        <i class="fa-regular fa-comment comments" data-trajet="${a.IdTrajet}" style="font-size: 1.5rem; color: #2563eb;"></i>
                                        ${H}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `}).join(""),await x(),v&&v.checked&&await j(!0),initCommentsForDynamicTrajets()}w()}else{const d=await l.text();o.innerHTML=d}}catch{o.innerHTML="<p>Erreur lors de la recherche.</p>"}});async function M(e){const r=e.closest(".trajet");if(!r)return;const n=e.dataset.id;if(!n)return;let t=document.getElementById(`details-${n}`);if(t||(t=r.querySelector(`.trajet-details-${n}`)),t||(t=r.querySelector(".trajet-details")),t){const i=!t.offsetParent||t.style.display==="none"||t.style.display==="";t.style.display=i?"block":"none";const s=r.querySelector(`.btn-details-${n}`)||e;s&&(s.textContent=i?"Masquer":"Détails"),i&&t.scrollIntoView({behavior:"smooth",block:"center"});return}try{const i=await fetch(`/trajets/${n}`,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(i.ok){const s=await i.json();t=document.createElement("div"),t.className="trajet-details",t.style="margin-top:8px;border-top:1px dashed #eee;padding-top:8px;font-size:.95rem;display:block;",t.innerHTML=`
                    <div><strong>Détails complets</strong></div>
                    <div>ID Trajet : ${s.IdTrajet??"—"}</div>
                    <div>Conducteur : ${s.NomConducteur??"—"} (ID ${s.IdConducteur??"—"})</div>
                    <div>Distance : ${s.Distance??"—"}</div>
                    <div>Départ : ${s.Depart??"—"}</div>
                    <div>Destination : ${s.Destination??"—"}</div>
                    <div>Date / Heure : ${s.DateTrajet??"—"} ${s.HeureTrajet??""}</div>
                    <div>Places disponibles : ${s.PlacesDisponibles??"—"}</div>
                    <div>Prix : ${Number(s.Prix??0).toFixed(2)}$</div>
                    <div>Animaux acceptés : ${s.AnimauxAcceptes?"Oui":"Non"}</div>
                    <div>Type conversation : ${s.TypeConversation??"—"}</div>
                    <div>Musique : ${s.Musique?"Oui":"Non"} — Fumeur : ${s.Fumeur?"Oui":"Non"}</div>
                    ${s.Description?`<div style="margin-top:6px;">Description : ${s.Description}</div>`:""}
                `,r.appendChild(t),t.scrollIntoView({behavior:"smooth",block:"center"})}else t=document.createElement("div"),t.className="trajet-details",t.style="margin-top:8px;border-top:1px dashed #eee;padding-top:8px;font-size:.95rem;display:block;color:#a00;",t.textContent="Détails non disponibles",r.appendChild(t)}catch{const s=document.createElement("div");s.className="trajet-details",s.style="margin-top:8px;border-top:1px dashed #eee;padding-top:8px;font-size:.95rem;display:block;color:#a00;",s.textContent="Erreur réseau lors du chargement des détails",r.appendChild(s)}}async function L(e){const r=e.dataset.id,n=e.closest(".trajet"),t=n&&n.querySelector(".places-select"),i=Number(t?.value||1),s=n&&n.querySelector(".places-dispo"),l=s?Number(s.textContent):null;if(l!==null&&i>l){alert("Le nombre de places demandé dépasse les places disponibles.");return}e.disabled=!0;const c=e.textContent;e.textContent="Ajout en cours…";try{const d=await fetch("/reservations",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.csrfToken||"","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({IdTrajet:Number(r),PlacesReservees:i})}),f=d.headers.get("content-type")||"";let a;if(f.includes("application/json")?a=await d.json():a={message:await d.text()},d.ok){if(s){const m=Math.max(0,Number(s.textContent)-i);s.textContent=m}e.textContent="Redirection vers le panier...",setTimeout(()=>{window.location.href="/cart"},500)}else alert(a.error||a.message||"Erreur lors de l'ajout"),e.textContent=c,e.disabled=!1}catch{alert("Erreur réseau lors de l'ajout"),e.textContent=c,e.disabled=!1}}function T(e){const r=e.target.closest(".btn-favorite");if(r){if(r.disabled||r.hasAttribute("data-processing")){e.preventDefault(),e.stopPropagation();return}e.preventDefault(),e.stopPropagation(),$(r);return}if(e.target.classList.contains("fa-star")||e.target.classList.contains("fa-regular")||e.target.classList.contains("fa-solid")){const i=e.target.closest(".btn-favorite");if(i){if(i.disabled||i.hasAttribute("data-processing")){e.preventDefault(),e.stopPropagation();return}e.preventDefault(),e.stopPropagation(),$(i);return}}const n=e.target.closest(".btn-details");if(n&&!n.hasAttribute("onclick")){M(n);return}const t=e.target.closest(".btn-add");if(t){L(t);return}}o.addEventListener("click",T),document.addEventListener("click",function(e){const r=e.target.closest(".trajet");r&&r.closest("#results")||r&&T(e)}),window.initCommentsForDynamicTrajets=async function(){document.querySelectorAll("#results i.comments").forEach(r=>{const n=r.dataset.trajet;if(!n)return;const t=r.cloneNode(!0);r.parentNode.replaceChild(t,r);const i=t.closest(".comment-icon-wrapper");i&&(i.addEventListener("click",async s=>{s.stopPropagation();const l=i.closest('div[style*="min-height: 40px"]');if(!l)return;let c=l.querySelector(`#CommentsContainer${n}`);if(c)c.style.display==="none"?c.style.display="block":c.style.display="none";else{c=document.createElement("div"),c.className="commentsWrapper",c.id=`CommentsContainer${n}`,c.style.cssText="display: block; margin-top: 48px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;",c.innerHTML="<p>Chargement des commentaires...</p>",l.appendChild(c);try{const d=await fetch(`/api/comments/${n}`);if(d.ok){const f=await d.json();f.length===0?c.innerHTML=`
                                    <div class="commentsContainer" style="padding: 16px; background: white; border-radius: 8px;">
                                        <p style="color: #666; margin: 0;">Aucun commentaire pour ce trajet.</p>
                                    </div>
                                `:c.innerHTML=f.map(a=>{const m=a.Note?Array.from({length:5},(g,y)=>y<a.Note?'<i class="fa-solid fa-star" style="color: #fbbf24;"></i>':"").join(""):"";return`
                                        <div class="commentsContainer" style="padding: 16px; background: white; border-radius: 8px; margin-top: 8px; border-left: 4px solid #2563eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                                            <div class="comment-header" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span class="comment-user" style="font-weight: 600; color: #2563eb;">${a.user_prenom} ${a.user_nom}</span>
                                                <span class="comment-date" style="color: #666; font-size: 0.85rem;">${a.DateCommentaire}</span>
                                            </div>
                                            <div class="comment-body" style="margin-bottom: 8px; color: #374151; line-height: 1.5;">${a.Commentaire}</div>
                                            ${m?`<div style="margin-top: 4px;">${m}</div>`:""}
                                        </div>
                                    `}).join("")}else c.innerHTML='<p style="color: #dc2626; padding: 12px;">Erreur lors du chargement des commentaires.</p>'}catch{c.innerHTML='<p style="color: #dc2626; padding: 12px;">Erreur réseau lors du chargement des commentaires.</p>'}}}),t.addEventListener("mouseenter",()=>{t.classList.replace("fa-regular","fa-solid")}),t.addEventListener("mouseleave",()=>{t.classList.replace("fa-solid","fa-regular")}))})}});
