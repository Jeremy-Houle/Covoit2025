window.ReservationsFavoritesManager={_favoritesCache:null,getFavorites:async function(){this._favoritesCache=null;try{const n="/api/favoris?type=reserver&_="+Date.now(),a=await fetch(n,{method:"GET",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},cache:"no-store"});if(a.ok){const s=await a.json(),o=Array.isArray(s)?s:[];return this._favoritesCache=o,o}else return a.status===401?(this._favoritesCache=[],[]):(this._favoritesCache=[],[])}catch{return this._favoritesCache=[],[]}},toggleFavorite:async function(n){if(this._toggling)return await new Promise(a=>setTimeout(a,100)),this.toggleFavorite(n);this._toggling=!0;try{const a=await fetch("/api/favoris/toggle",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.csrfToken||"","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({IdTrajet:Number(n),TypeFavori:"reserver"})});if(a.ok){const s=await a.json();return this._favoritesCache=null,await this.getFavorites(),s.isFavorite!==void 0?s.isFavorite:s.success===!0}else{if(a.status===401)return alert("Veuillez vous connecter pour ajouter des trajets aux favoris."),!1;{const s=await a.json().catch(()=>({}));return alert(s.message||"Erreur lors de l'ajout aux favoris"),!1}}}catch{return alert("Erreur rÃ©seau lors de l'ajout aux favoris"),!1}finally{this._toggling=!1}}};document.addEventListener("DOMContentLoaded",function(){window.ReservationsFavoritesManager&&(window.ReservationsFavoritesManager._favoritesCache=null);async function n(){if(!document.querySelector(".reservations-container"))return;const o=Array.from(document.querySelectorAll(".reservation-card"));if(o.length===0)return;let i=window.ReservationsFavoritesManager._favoritesCache;(!i||i.length===0)&&(i=await window.ReservationsFavoritesManager.getFavorites()),Array.isArray(i)||(i=[]);const l=[],e=[];o.forEach(t=>{const c=t.dataset.trajetId,r=t.dataset.dateTrajet;c&&i.includes(String(c))?l.push({card:t,dateTrajet:r}):e.push({card:t,dateTrajet:r})}),l.sort((t,c)=>{const r=new Date(t.dateTrajet),f=new Date(c.dateTrajet);return r-f}),e.sort((t,c)=>{const r=new Date(t.dateTrajet),f=new Date(c.dateTrajet);return r-f});const d=o[0].parentNode;l.forEach(({card:t})=>{d.appendChild(t)}),e.forEach(({card:t})=>{d.appendChild(t)})}async function a(){if(typeof window.ReservationsFavoritesManager>"u"){setTimeout(a,100);return}const s=document.querySelectorAll(".reservation-card"),o=await window.ReservationsFavoritesManager.getFavorites();s.forEach(i=>{const l=i.dataset.trajetId||i.querySelector("[data-trajet-id]")?.dataset.trajetId;if(!l)return;const e=i.querySelector(".btn-favorite");if(!e)return;const d=o.includes(String(l));e.classList.remove("active"),e.innerHTML='<i class="fa-regular fa-star"></i>',e.style.color="#666",e.title="Ajouter aux favoris",d&&(e.classList.add("active"),e.innerHTML='<i class="fa-solid fa-star"></i>',e.style.color="#ffc107",e.title="Retirer des favoris"),e.addEventListener("click",async function(t){if(t.preventDefault(),t.stopPropagation(),e.disabled||e.hasAttribute("data-processing"))return;e.setAttribute("data-processing","true"),e.disabled=!0;const c=e.innerHTML;e.innerHTML='<i class="fa fa-spinner fa-spin"></i>';try{const r=await window.ReservationsFavoritesManager.toggleFavorite(l);e.classList.toggle("active",r),e.innerHTML=r?'<i class="fa-solid fa-star"></i>':'<i class="fa-regular fa-star"></i>',e.style.color=r?"#ffc107":"#666",e.title=r?"Retirer des favoris":"Ajouter aux favoris",await n()}catch{e.innerHTML=c}finally{e.disabled=!1,e.removeAttribute("data-processing")}})}),n()}a()});
